include Make.inc
mySRCdir = $(SRCdir)/lib
#
# override with libatlas.so.3.0 only when atlas is built to one lib
#
DYNlibs = liblapack_atlas.so.3.0 libf77blas.so.3.0 libcblas.so.3.0 libatlas.so.3.0 
PTDYNlibs = liblapack_atlas.so.3.0 libptf77blas.so.3.0 libptcblas.so.3.0 libatlas.so.3.0 
CDYNlibs = liblapack_atlas.so.3.0 libcblas.so.3.0 libatlas.so.3.0 
CPTDYNlibs = liblapack_atlas.so.3.0 libptcblas.so.3.0 libatlas.so.3.0 

VER=3.8.4
tarnam = atlas$(VER)_$(ARCH)
tar : tarfile
tarfile : $(tarnam).tgz
$(tarnam).tgz :
	mkdir $(ARCH)
	cd $(ARCH) ; mkdir include lib
	cp $(TOPdir)/doc/LibReadme.txt $(ARCH)/README
	cp $(TOPdir)/Make.$(ARCH) $(ARCH)/.
	cp $(BINdir)/INSTALL_LOG/SUMMARY.LOG $(ARCH)/.
	cp $(INCSdir)/cblas.h $(ARCH)/include/.
	cp $(INCSdir)/clapack.h $(ARCH)/include/.
	cp $(LIBdir)/libatlas.a $(ARCH)/lib/.
	cp $(LIBdir)/libf77blas.a $(ARCH)/lib/.
	cp $(LIBdir)/libcblas.a $(ARCH)/lib/.
	cp $(LIBdir)/liblapack_atlas.a $(ARCH)/lib/.
	- cp $(LIBdir)/libptcblas.a $(ARCH)/lib/.
	- cp $(LIBdir)/libptf77blas.a $(ARCH)/lib/.
	$(TAR) cf $(tarnam).tar $(ARCH)
	rm -rf $(ARCH)
	$(GZIP) --best $(tarnam).tar
	mv $(tarnam).tar.gz $(tarnam).tgz

# Soft link creation
# XXX: I cannot make default rule work for some reason...
libatlas.so: libatlas.so.3
	rm -f $@
	ln -s $< $@ 

libatlas.so.3: libatlas.so.3.0
	rm -f $@
	ln -s $< $@ 

libcblas.so: libcblas.so.3
	rm -f $@
	ln -s $< $@ 

libcblas.so.3: libcblas.so.3.0
	rm -f $@
	ln -s $< $@ 

libf77blas.so: libf77blas.so.3
	rm -f $@
	ln -s $< $@ 

libf77blas.so.3: libf77blas.so.3.0
	rm -f $@
	ln -s $< $@ 

liblapack_atlas.so: liblapack_atlas.so.3
	rm -f $@
	ln -s $< $@ 

liblapack_atlas.so.3: liblapack_atlas.so.3.0
	rm -f $@
	ln -s $< $@ 

atlas/libblas.so: atlas/libblas.so.3
	rm -f $@
	(cd atlas && ln -s libblas.so.3 libblas.so)

atlas/libblas.so.3: atlas/libblas.so.3.0
	rm -f $@
	(cd atlas && ln -s libblas.so.3.0 libblas.so.3)

atlas/liblapack.so: atlas/liblapack.so.3
	rm -f $@
	(cd atlas && ln -s liblapack.so.3 liblapack.so)

atlas/liblapack.so.3: atlas/liblapack.so.3.0
	rm -f $@
	(cd atlas && ln -s liblapack.so.3.0 liblapack.so.3)

# Build rules
ptshared :
	- rm -f libatlas.so.3.0 liblapack_atlas.so.3.0
	$(MAKE) libatlas.so.3.0 liblapack_atlas.so.3.0 libptf77blas.so.3.0 libf77blas.so.3.0 \
                libptcblas.so.3.0 libcblas.so.3.0 liblapack_atlas.so.3.0
shared :
	- rm -f libatlas.so.3.0 liblapack_atlas.so.3.0 libf77blas.so.3.0 libcblas.so.3.0 liblapack_atlas.so.3.0
	$(MAKE) libatlas.so.3.0 liblapack_atlas.so.3.0 libf77blas.so.3.0 libcblas.so.3.0 liblapack_atlas.so.3.0
fullshared :
	- rm -f atlas/libblas.so.3.0 atlas/liblapack.so.3.0
	$(MAKE) atlas/libblas.so.3.0 atlas/liblapack.so.3.0
cptshared :
	- rm -f libatlas.so.3.0 libclapack_atlas.so.3.0
	$(MAKE) libatlas.so.3.0 libclapack_atlas.so.3.0 libptcblas.so.3.0 libcblas.so.3.0
cshared :
	- rm -f libatlas.so.3.0 libclapack_atlas.so.3.0
	$(MAKE) libatlas.so.3.0 libclapack_atlas.so.3.0 libcblas.so.3.0

libatlas.so.3.0 : libatlas.a
	ld $(LDFLAGS) -shared -soname libatlas.so.3 -o $@ \
        --whole-archive libatlas.a --no-whole-archive -lc $(LIBS) $(F77SYSLIB)
liblapack_atlas.so.3.0 : liblapack_atlas.a libatlas.so libcblas.so libf77blas.so
	ld $(LDFLAGS) -shared -soname liblapack_atlas.so.3 -o $@ \
	  --whole-archive liblapack_atlas.a  \
	  --no-whole-archive -L. -lf77blas -lcblas -latlas -lm -lc $(F77SYSLIB)
libclapack_atlas.so.3.0 : libclapack_atlas.a
	ld $(LDFLAGS) -shared -soname liblapack_atlas.so.3.0 -o liblapack_atlas.so.3.0 \
           --whole-archive libclapack_atlas.a
libptf77blas.so.3.0 : libptf77blas.a
	ld $(LDFLAGS) -shared -soname $@ -o $@ --whole-archive libptf77blas.a \
           --no-whole-archive $(F77SYSLIB)
libf77blas.so.3.0 : libf77blas.a libcblas.so libatlas.so
	ld $(LDFLAGS) -shared -soname libf77blas.so.3 -o $@ \
	  --whole-archive libf77blas.a \
          --no-whole-archive -L. -lcblas -latlas $(F77SYSLIB) -lm -lc
libptcblas.so.3.0 : libptcblas.a
	ld $(LDFLAGS) -shared -soname $@ -o $@ --whole-archive libptcblas.a
libcblas.so.3.0 : libcblas.a libatlas.so
	ld $(LDFLAGS) -shared -soname libcblas.so.3 -o $@ \
	  --whole-archive libcblas.a \
          --no-whole-archive -L. -latlas $(F77SYSLIB) -lm -lc

# Build full netlib blas/lapack libraries:
atlas/libblas.a: libatlas.a libptf77blas.a libptcblas.a
	mkdir tmp
	(cd tmp && ar x ../libatlas.a);
	(cd tmp && ar x ../libptf77blas.a);
	(cd tmp && ar x ../libptcblas.a);
	ar r $@ tmp/*.o
	rm -rf tmp

atlas/liblapack.a: liblapack_atlas.a libatlas.a
	mkdir tmp
	(cd tmp && ar x /usr/lib/liblapack_pic.a);
	(cd tmp && ar x ../liblapack_atlas.a);
	(cd tmp && ar x ../libptcblas.a);
	ar r $@ tmp/*.o
	rm -rf tmp

atlas/libblas.so.3.0: atlas/libblas.a libatlas.so
	ld $(LDFLAGS) -shared -soname libblas.so.3 -o $@ \
	   --whole-archive atlas/libblas.a \
           --no-whole-archive $(F77SYSLIB) -lm -lc

atlas/liblapack.so.3.0: atlas/liblapack.a atlas/libblas.so
	ld $(LDFLAGS) -shared -soname liblapack.so.3 -o $@ \
	   --whole-archive atlas/liblapack.a \
           --no-whole-archive -L . -lblas $(F77SYSLIB) -lm -lc
#
# Builds one shared lib from all ATLAS files
#
fat_ptshared :                              # threaded target
	ld $(LDFLAGS) -shared -soname libatlas.so.3.0 -o libatlas.so.3.0 \
        --whole-archive liblapack_atlas.a libptf77blas.a libptcblas.a libatlas.a \
           --no-whole-archive -lc $(F77SYSLIB) $(LIBS)
fat_shared :                                # unthreaded target
	ld $(LDFLAGS) -shared -soname libatlas.so.3.0 -o libatlas.so.3.0 \
        --whole-archive liblapack_atlas.a libf77blas.a libcblas.a libatlas.a \
           --no-whole-archive -lc $(F77SYSLIB) $(LIBS)
#
# Builds shared lib, not include fortran codes from LAPACK
#
fat_cptshared : libclapack_atlas.a                # threaded target
	ld $(LDFLAGS) -shared -soname libcatlas.so.3.0 -o libcatlas.so.3.0 \
        --whole-archive libclapack_atlas.a libptcblas.a libatlas.a \
        --no-whole-archive -lc $(LIBS)
fat_cshared : libclapack_atlas.a                  # unthreaded target
	ld $(LDFLAGS) -shared -soname libcatlas.so.3.0 -o libcatlas.so.3.0 \
        --whole-archive libclapack_atlas.a libcblas.a libatlas.a \
        --no-whole-archive -lc $(LIBS)

libclapack_atlas.a : liblapack_atlas.a
	rm -rf clapack libclapack_atlas.a
	mkdir clapack
	cd clapack ; ar x ../liblapack_atlas.a
	rm -f clapack/*f77wrap* 
	ar r libclapack_atlas.a clapack/ATL_* clapack/clapack_*
	rm -rf clapack
xtst_lp: $(DYNlibs)
	$(ICC) $(CDEFS) -o $@ $(mySRCdir)/qr.c $(DYNlibs) -Wl,--rpath ./
xtst : $(DYNlibs)
	$(ICC) $(CDEFS) -o $@ $(mySRCdir)/test_dynlink.c $(DYNlibs) \
           -Wl,--rpath ./

xtry_lp:
	$(ICC) $(CDEFS) -o $@ $(mySRCdir)/qr.c libatlas.so.3.0 -Wl,--rpath ./
xtry :
	$(ICC) $(CDEFS) -o $@ $(mySRCdir)/test_dynlink.c libatlas.so.3.0 \
           -Wl,--rpath ./
xtry_c :
	$(ICC) $(CDEFS) -o $@ $(mySRCdir)/test_dynlink.c libcatlas.so.3.0 \
           -Wl,--rpath ./
